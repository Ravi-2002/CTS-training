/**
 * @jest-environment jsdom
 */
import React from "react";
import { render, screen, fireEvent } from "@testing-library/react";
import Submission from "./Submission";
import { Router } from "react-router-dom";
import { createMemoryHistory } from "history";
import landingData from "../../../../mock/scan/get/landing.json";
import { postHttpClientRequest } from "../httpClient";

jest.mock("../httpClient", () => ({
  postHttpClientRequest: jest.fn(),
}));

// Mock reactGlobals
global.reactGlobals = {
  baseUrl: "https://base/",
  submitUrl: "submit",
  locationCode: "LOC123",
  ssCluster: "CLUSTER1",
  transactionId: "TID100",
  destinationFlow: "SCAN_ID",
  manageTouchlessScanFFlag: true
};

// Mock landing text
landingData.content = {
  submitPage: {
    reTaketitle: "Retake Title",
    retake: "Retake",
    submit: "Submit"
  }
};

const renderWithRouter = (ui, routeState = {}) => {
  const history = createMemoryHistory();
  history.location.state = routeState;

  return {
    ...render(<Router history={history}>{ui}</Router>),
    history,
  };
};

describe("Submission Component - 100% Coverage", () => {

  beforeEach(() => {
    jest.clearAllMocks();
  });

  test("renders UI with image when imageUrl exists", () => {
    const { history } = renderWithRouter(<Submission />, { url: "data:image/png;base64,ABC123==" });

    expect(screen.getByAltText("Screenshot")).toBeInTheDocument();
    expect(screen.getByText("Retake Title")).toBeInTheDocument();
    expect(screen.getByText("Retake")).toBeInTheDocument();
    expect(screen.getByText("Submit")).toBeInTheDocument();
  });

  test("routeToScanPage: clicking Retake navigates to /scan", () => {
    const { history } = renderWithRouter(<Submission />, { url: "data:image/png;base64,ABC123==" });

    fireEvent.click(screen.getByText("Retake"));
    expect(history.location.pathname).toBe("/scan");
  });

  test("submitIdDocument: sends request, pushes to success when manageTouchlessScanFFlag = true", () => {
    const { history } = renderWithRouter(<Submission />, { url: "data:image/png;base64,ABC123==" });

    fireEvent.click(screen.getByText("Submit"));

    // Verify post API called
    expect(postHttpClientRequest).toHaveBeenCalledTimes(1);

    // Verify navigation
    expect(history.location.pathname).toBe("/success");
  });

  test("buildReqData: sets optOut=N + correct idImageFront when imageUrl exists", () => {
    const { history } = renderWithRouter(<Submission />, { url: "data:image/png;base64,XYZ123" });

    fireEvent.click(screen.getByText("Submit"));

    const lastCall = postHttpClientRequest.mock.calls[0][1]; // reqData

    expect(lastCall.idImageFront).toBe("XYZ123");
    expect(lastCall.customerOpted).toBe("Y");
    expect(lastCall.transactionType).toBe("MVO_ID_ADT_AUTH_TOUCHLESS");
  });

  test("buildReqData: sets optOut=Y + no image when imageUrl missing", () => {
    const { history } = renderWithRouter(<Submission />, {}); // No URL

    fireEvent.click(screen.getByText("Submit"));

    const lastCall = postHttpClientRequest.mock.calls[0][1];

    expect(lastCall.idImageFront).toBe("");
    expect(lastCall.customerOpted).toBe("N");
    expect(lastCall.transactionType).toBe("MVO_ID_ADT_AUTH_NOTHANKS");
  });

  test("populateTransactionType: covers all 4 branches", () => {
    const { history } = renderWithRouter(<Submission />, { url: "data:image/png;base64,AAA" });

    // Case 1: destinationFlow=SCAN_ID, opted in
    reactGlobals.destinationFlow = "SCAN_ID";
    fireEvent.click(screen.getByText("Submit"));
    let req = postHttpClientRequest.mock.calls[0][1];
    expect(req.transactionType).toBe("MVO_ID_ADT_AUTH_TOUCHLESS");

    jest.clearAllMocks();

    // Case 2: destinationFlow != SCAN_ID, opted in
    reactGlobals.destinationFlow = "OTHER_FLOW";
    fireEvent.click(screen.getByText("Submit"));
    req = postHttpClientRequest.mock.calls[0][1];
    expect(req.transactionType).toBe("MVO_ID_SMART_LINK_TOUCHLESS");

    jest.clearAllMocks();

    // Case 3: opted out (no image) + SCAN_ID
    renderWithRouter(<Submission />, {}); // no URL
    reactGlobals.destinationFlow = "SCAN_ID";
    fireEvent.click(screen.getByText("Submit"));
    req = postHttpClientRequest.mock.calls[0][1];
    expect(req.transactionType).toBe("MVO_ID_ADT_AUTH_NOTHANKS");

    jest.clearAllMocks();

    // Case 4: opted out + OTHER_FLOW
    const { history: h2 } = renderWithRouter(<Submission />, {});
    reactGlobals.destinationFlow = "OTHER_FLOW";
    fireEvent.click(screen.getByText("Submit"));
    req = postHttpClientRequest.mock.calls[0][1];
    expect(req.transactionType).toBe("MVO_ID_SMART_LINK_NOTHANKS");
  });

});