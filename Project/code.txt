import React from "react";
import { shallow } from "enzyme";
import BlockServices from "../BlockServices";

describe("BlockServices toggleOn()", () => {
  let wrapper;
  let instance;
  let mockPostServices;
  let mockPreventDefault;

  beforeEach(() => {
    mockPostServices = jest.fn().mockResolvedValue({ responseCode: "00" });
    mockPreventDefault = jest.fn();

    const props = {
      selectedDevice: { encryptedMtn: "mockedEncryptedMdn" },
      actions: { postServices: mockPostServices },
    };

    wrapper = shallow(<BlockServices {...props} />);
    instance = wrapper.instance();

    instance.setState({
      successMsg: "old message",
      pendingService: null,
      services: {
        main: {
          data: [
            { sfoCode: "SFO123", sfoEnabled: "Y" },
            { sfoCode: "SFO456", sfoEnabled: "N" },
          ],
        },
      },
    });
  });

  it("toggles from Y → N and calls postServices with correct payload", async () => {
    const e = { preventDefault: mockPreventDefault };

    await instance.toggleOn(e, "main", 0);

    // Wait for async setState to complete
    await Promise.resolve();

    expect(mockPreventDefault).toHaveBeenCalledTimes(1);
    expect(mockPostServices).toHaveBeenCalledWith({
      mdn: "mockedEncryptedMdn",
      sfoCode: "SFO123",
      sfoEnabled: "N",
    });

    expect(instance.state.successMsg).toBe("");
    expect(instance.state.pendingService).toEqual({ service: "main", i: 0 });
  });

  it("toggles from N → Y and calls postServices with correct payload", async () => {
    const e = { preventDefault: mockPreventDefault };

    await instance.toggleOn(e, "main", 1);

    await Promise.resolve();

    expect(mockPreventDefault).toHaveBeenCalledTimes(1);
    expect(mockPostServices).toHaveBeenCalledWith({
      mdn: "mockedEncryptedMdn",
      sfoCode: "SFO456",
      sfoEnabled: "Y",
    });

    expect(instance.state.successMsg).toBe("");
    expect(instance.state.pendingService).toEqual({ service: "main", i: 1 });
  });
});