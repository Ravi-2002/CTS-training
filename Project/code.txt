import React from "react";
import { render, screen, fireEvent } from "@testing-library/react";
import { Router } from "react-router-dom";
import { createMemoryHistory } from "history";
import ViewLimitations from "../ViewLimitation";
import "@testing-library/jest-dom";
import { Provider } from "react-redux";
import configureStore from "redux-mock-store";

// Mock native title setter
import { nativeSetTitle } from "../../../../../shared/utilities/native";
jest.mock("../../../../../shared/utilities/native", () => ({
  nativeSetTitle: jest.fn(),
}));

// Mock common.getItemValue
jest.mock("../../../../../shared/utilities/util", () => ({
  __esModule: true,
  default: {
    getItemValue: (items, key) => {
      const found = items?.find((i) => i.key === key);
      return found ? found.value : "";
    },
  },
}));

const mockStore = configureStore([]);

const buildStore = (flag) =>
  mockStore({
    Detail: {
      callsMessages: {
        blocksAEMFFlag: flag,
        sections: [
          {
            sections: [
              {
                contents: [
                  {
                    items: [
                      {
                        key: "ViewLimitationTitle",
                        value: "Test Title",
                      },
                      {
                        key: "ViewLimitaionMsg",
                        value: "<span>Test HTML Message</span>",
                      },
                    ],
                  },
                ],
              },
            ],
          },
        ],
      },
    },
  });

const RenderWithProviders = (store, history) => {
  return render(
    <Provider store={store}>
      <Router history={history}>
        <ViewLimitations />
      </Router>
    </Provider>
  );
};

describe("ViewLimitations FULL COVERAGE", () => {
  it("covers AEMFFlag = true (Body branch)", () => {
    const history = createMemoryHistory();
    const store = buildStore(true);

    RenderWithProviders(store, history);

    // useEffect coverage
    expect(nativeSetTitle).toHaveBeenCalledWith("View Limitations", false);

    // Title coverage
    expect(screen.getByText("Test Title")).toBeInTheDocument();

    // Body + HTML message branch
    expect(screen.getByText("Test HTML Message")).toBeInTheDocument();
  });

  it("covers AEMFFlag = false (default text branch)", () => {
    const history = createMemoryHistory();
    const store = buildStore(false);

    RenderWithProviders(store, history);

    expect(
      screen.getByText(/Blocking a number for calls and text is easy/i)
    ).toBeInTheDocument();
  });

  it("covers goBack() on Done button click", () => {
    const history = createMemoryHistory();
    history.push("/view-limitations");

    const spy = jest.spyOn(history, "goBack");

    const store = buildStore(false);
    RenderWithProviders(store, history);

    fireEvent.click(screen.getByRole("button", { name: /Done/i }));

    expect(spy).toHaveBeenCalled();
  });
});