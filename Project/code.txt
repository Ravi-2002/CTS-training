import React, { Component, Fragment } from "react";
import { connect } from "react-redux";
import { bindActionCreators } from "redux";
import styled from "styled-components";
import '../../../blocks/home/components/style.css';
import { getCallsMessages,postaddBlockCallMsg, postDeleteBlockCallMsg } from "../actions/fetchCallsMessages";
import Alert from "../../alert";
import { Input } from "@vds/inputs";
import { Body, Title } from "@vds/typography";
import { Button, TextLink } from "@vds/buttons";
import { mobileNumberFormat } from "../../../../shared/utilities/commonExp";
import { Col, Grid, Row } from "@vds/grids";
import { Loader } from "@vds/loaders";
import '../../../blocks/styles.css'
import common from "../../../../shared/utilities/util";


class BlockCallsMessages extends Component {
  constructor(props) {
    super(props)
    this.state = {
      open: false,
      powerCycle: false,
      errorMsg: null,
      newNumber: '',
      applyAllFlag: false,
      date: new Date(),
      blockedList: [],
      expiredList: [],
      addSuccess: null,
      failSuccess: null,
      deleteSuccess: null,
      blockAgainSuccess: null,
      addnumberValid: null,
      remainingBlockCount: null,
      openToggleBCE: false,
      openToggleSM: false,
      trackingId: "",
      successMsg: "",
      failureMsg: "",

    }
  }
  handleOnChange = (e, inputType, row) => {
    let x = e.target.value
      .replace(/\D/g, "")
      .match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
    let value = !x[2]
      ? x[1]
      : "" + x[1] + "." + x[2] + (x[3] ? "." + x[3] : "");

    this.setState({ newNumber: value }, () => this.handleInput(e, inputType, row));
  };
  handleInput = (event, inputType, row) => {
    if (inputType == "number") {
      let inputValue = this.state.newNumber;
      let x = inputValue
        .replace(/\D/g, "")
        .match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
      let changedValue = x[1] + x[2] + x[3];
      const validateDigit = /^\d+$/;
      if (validateDigit.test(changedValue) || changedValue == "") {
          this.setState({ newNumber: inputValue });
      }
      if (changedValue.length === 10 && validateDigit.test(changedValue)) {
          this.setState({ addnumberValid: true });
      }
      else {
          this.setState({ newNumber: inputValue });
          this.setState({ addnumberValid: false });
        }

      }
    else {
      this.setState({
        applyAllFlag: event.target.checked
      });
    }
  }
  handleAddNumber = (e) => {
    let inputValue = this.state.newNumber;
    let x = inputValue
      .replace(/\D/g, "")
      .match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
    let changedValue = x[1] + x[2] + x[3];
    let payload = {
      mtn: this.props.selectedDevice?.encryptedMtn,
      blockNumber: changedValue,
      oldPhoneNumber: changedValue,
      memo: this.state.newMemo,
      expiredPhoneNumber: "",
      blockedNumbers: [],
      applyAll: this.state.applyAllFlag,
      onlyMemo: false
    }
    this.props.postaddBlockCallMsg(payload).then(() => {
      let elmnt = document.getElementById("myalert");
      if (elmnt != null)
        window.scrollTo(0, elmnt.offsetTop);
      if (this.props.addBlockCallMsgRes.statusCode === "00") {
        this.setState({
          errorMsg: null,
          powerCycle: this.props.addBlockCallMsgRes?.powerCycle,
          newNumber: '',
          newMemo: '',
          blockedList: this.props.addBlockCallMsgRes.blockedPhoneNumbers,
          expiredList: this.props.addBlockCallMsgRes.expiredBlockedPhoneNumbers,
          remainingBlockCount: this.props.addBlockCallMsgRes.remainingBlockCount
        })
        if (this.props.addBlockCallMsgRes.hasFailureMsg && this.props.addBlockCallMsgRes.hasSuccessMsg) {
          this.setState({
            addSuccess: true,
            failSuccess: true,
            trackingId: "CallsMessagesSuccessFailureNotification",
            deleteSuccess: null,
            editSuccess: null,
            blockAgainSuccess: null,
            editAllSuccess: null,
            newNumber: '',
            newMemo: ''
          })
        }
        else if (this.props.addBlockCallMsgRes.hasFailureMsg) {
          this.setState({
            addSuccess: null,
            failSuccess: true,
            trackingId: "CallsMessagesFailureNotification",
            deleteSuccess: null,
            editAllSuccess: null,
            editSuccess: null,
            blockAgainSuccess: null,
            failureMsg: this.props.addBlockCallMsgRes.failureMsg
          })
        }
        else if (this.props.addBlockCallMsgRes.hasSuccessMsg) {
          this.setState({
            addSuccess: true,
            failSuccess: null,
            trackingId: "CallsMessagesSuccessNotification",
            deleteSuccess: null,
            editAllSuccess: null,
            editSuccess: null,
            blockAgainSuccess: null,
            successMsg: this.props.addBlockCallMsgRes.successMsg
          })

        }
      }
      else {
        this.setState({
          errorMsg: true,
          addSuccess: null,
          failSuccess: null,
          deleteSuccess: null,
          editAllSuccess: null,
          editSuccess: null,
          blockAgainSuccess: null,
          trackingId: "CallsMessagesFailureNotification"
        })
      }

    });
    e.preventDefault();
  }
  componentDidUpdate(prevProps) {
    if (prevProps.blockedNumbers !== this.props.blockedNumbers && prevProps.callsMessagesData !== this.props.callsMessagesData) {
      this.setState({
        blockedList: this.props.blockedNumbers,
        remainingBlockCount: this.props?.callsMessagesData?.remainingBlockCount
      });
    }
    if (prevProps.addBlockCallMsgRes !== this.props.addBlockCallMsgRes) {
      this.setState({
        blockedList: this.props.addBlockCallMsgRes?.blockedPhoneNumbers,
        remainingBlockCount: this.props.addBlockCallMsgRes?.remainingBlockCount,
        successMsg: this.props.addBlockCallMsgRes.successMsg,
        failureMsg: this.props.addBlockCallMsgRes.failureMsg,
        addSuccess: this.props.addBlockCallMsgRes.hasSuccessMsg,
        failSuccess: this.props.addBlockCallMsgRes.hasFailureMsg,
        newNumber:''

      });
    }

    if (prevProps.deleteBlockCallMsgRes !== this.props.deleteBlockCallMsgRes) {
      this.setState({
        blockedList: this.props.deleteBlockCallMsgRes?.blockedPhoneNumbers,
        remainingBlockCount: this.props.deleteBlockCallMsgRes?.remainingBlockCount,
        successMsg: this.props.deleteBlockCallMsgRes.successMsg,
        failureMsg: this.props.deleteBlockCallMsgRes.failureMsg,
        deleteSuccess: this.props.deleteBlockCallMsgRes.hasSuccessMsg,
        newNumber:''
      });
    }
  }
  deleteNumber = (e, number) => {
    e.preventDefault();
    if (reactGlobals.isCsr) {
      return;
    }
    let payload = {
      mtn: this.props.selectedDevice?.encryptedMtn,
      blockNumber: number.phoneNumber,
      oldPhoneNumber: number.phoneNumber,
      expiredPhoneNumber: "",
      blockedNumbers: [],
      memo: number.memo,
      applyAll: false,
      onlyMemo: false
    }

    this.props.postDeleteBlockCallMsg(payload).then(() => {
      let elmnt = document.getElementById("myalert");
      if (elmnt != null)
        window.scrollTo(0, elmnt.offsetTop);
      if (this.props.deleteBlockCallMsgRes.statusCode == "00") {
        this.setState({
          deleteSuccess: true,
          trackingId: "CallsMessagesSuccessNotification",
          errorMsg: null,
          failSuccess: null,
          addSuccess: null,
          failSuccess: null,
          editSuccess: null,
          editAllSuccess: null,
          blockAgainSuccess: null,
          blockedList: this.props.deleteBlockCallMsgRes.blockedPhoneNumbers,
          expiredList: this.props.deleteBlockCallMsgRes.expiredBlockedPhoneNumbers,
          remainingBlockCount: this.props.deleteBlockCallMsgRes.remainingBlockCount,
          successMsg: this.props.deleteBlockCallMsgRes.successMsg,
          failureMsg: this.props.deleteBlockCallMsgRes.failureMsg
        })
      } else {
        this.setState({
          addSuccess: null,
          errorMsg: null,
          deleteSuccess: false,
          trackingId: "CallsMessagesFailureNotification",
          editAllSuccess: null,

          failSuccess: null,
          editSuccess: null,
          blockAgainSuccess: null
        })
      }
    });
  }
  handleCallsMessages = (e) => {
    e.preventDefault();
    this.props.selectAccordian('CM');
    const { open } = this.state
    this.setState({
      open: !open,
      newNumber: '',
      newMemo: '',
      errorMsg: null,
      failSuccess: null,
      addSuccess: null,
      deleteSuccess: null,
      editAllSuccess: null,
      editNumber: false,
      editAllNumber: false,
      editSuccess: null,
      blockAgainSuccess: null,
      addnumberValid: null
    })
    if (open == false || this.props.selectedAccordian == '') {
      let payload = {
        mtn: this.props.selectedDevice?.encryptedMtn
      }
      this.props.getCallsMessages(payload).then(() => {
        let elmnt = document.getElementById("myalert");
        if (elmnt != null)
          window.scrollTo(0, elmnt.offsetTop);
        if (this.props.blockedNumbers && this.props.blockedNumbers) {
          let blockedNumbers = this.props.blockedNumbers;
          blockedNumbers.forEach(element => {
            element.isEdit = false,
              element.oldMemo = element.memo
          });
          this.setState({ blockedList: blockedNumbers });
          this.setState({ remainingBlockCount: this.props.callsMessagesData.remainingBlockCount, addedBlockCount: this.props.callsMessagesData.addedBlockCount })
        } else {
          this.setState({ blockedList: [] });
        }
        if (this.props.expiredNumbers && this.props.expiredNumbers) {
          this.setState({ expiredList: this.props.expiredNumbers });
        } else {
          this.setState({ expiredList: [] });
        }
      });
    }
  }
  

  handleToggle = (event, openToggleBCE) => {

    event.preventDefault();

    if (event.target.id == "blockedcontactexperience") {
      this.setState({
        openToggleBCE: !openToggleBCE
      });
    }

  };

  handleToggleSM = (event, openToggleSM) => {
    event.preventDefault();
    if (event.target.id == "Reportsuspectedspamtextmessages") {
      this.setState({
        openToggleSM: !openToggleSM
      });
    }
  };
  render() {
    const { openToggleBCE, openToggleSM } = this.state
    let pageContent;
    if (this.props.callsMessagesData && this.props.callsMessagesData?.sections) {
      pageContent = common.getContentFromSection(this.props.callsMessagesData,'devicesBlocksMainSection');
      if(pageContent){
        pageContent = pageContent?.sections[0];
      }
    }
    const pageItems = pageContent && pageContent.contents && pageContent.contents[0].items;
    const pageActions = pageContent && pageContent.actions;
    const blocksAEMFFlag = this.props?.callsMessagesData?.blocksAEMFFlag || {};
    const blockedNumberList = this.state?.blockedList?.map(blockedNum => (
        <Fragment>
          <Row className="blocked-row">
              <Col >
                <MobileNumber>
                  <Body>{mobileNumberFormat(blockedNum.phoneNumber)}</Body>
                </MobileNumber>
              </Col>
            <Col>
              <Unblock >
                <Body><TextLink className={reactGlobals.isCsr ? "o-link btn-disabled" : "o-link"} onClick={(e) => this.deleteNumber(e, blockedNum)} data-track="CallsMessagesDesktopDeleteButton" ><Body bold>Unblock</Body></TextLink></Body>
              </Unblock>
            </Col>
          </Row>

        </Fragment>
    ));
    return (
      <div className="accordion">
        <Loader active={this?.props?.isFetching} fullscreen/>
        <div className="accordion__item">
          <div className="accordion__title"
            role="button"
            tabIndex="0" onClick={(e) => this.handleCallsMessages(e)} onKeyPress={(e) => this.handleCallsMessages(e)} aria-expanded={this.props.selectedAccordian == 'CM' ? true : false}
          >
            <div className="u-position-relative">
              <div className="accordion-title">
                <FAQsHeadSection id="blocksCallsAndMessages">
                  Block calls & messages
                </FAQsHeadSection>
              </div>
              <div
                id="blocksCallsAndMessages"
                className="accordion__arrow"
                role="presentation"
              />
            </div>
          </div>
          <div
            className={this.props.selectedAccordian == 'CM'
              ? 'accordion__body'
              : 'accordion__body accordion__body--hidden'
            }
            aria-hidden={this.props.selectedAccordian == 'CM' ? false : true} >
            <Body>
              <div >
                <div id="myalert" data-track={this.state.trackingId}>
                  <Title size="medium" bold='true'>{common.getItemValue(pageItems,"headerText")}</Title><br />
                  {/* {this.props.getCMError.statusCode == "01" && <Alert Message={this.props.getCMError.errorMessage} Type={3} closeBanner={true}></Alert>} */}
                  {/* <Alert  Message="my alert info" Type={1} closeBanner={false}></Alert>
                <Alert  Message="my alert info" Type={2} closeBanner={true}></Alert> */}
                  {this.state.addSuccess && <Alert Message={this.state.successMsg} Type={2} closeBanner={true}></Alert>}
                  {this.state.failSuccess && <Alert Message={this.state.failureMsg} Type={3} closeBanner={true}></Alert>}
                  {this.state.errorMsg && <Alert Message={this.props?.addBlockCallMsgRes?.errorMessage} Type={3} closeBanner={true}></Alert>}
                  {(this.state.addSuccess && this.props?.addBlockCallMsgRes?.hasFailureMsg) && <Alert Message={this.statefailureMsg} Type={3} closeBanner={true}></Alert>}
                  {this.state.editSuccess && <Alert Message={this.props.editBlockCallMsgRes.successMsg} Type={2} closeBanner={true}></Alert>}
                  {this.state.editSuccess == false && <Alert Message={this.props.editBlockCallMsgRes.failureMsg} Type={3} closeBanner={true}></Alert>}
                  {this.state.deleteSuccess && <Alert Message={this.state.successMsg} Type={2} closeBanner={true}></Alert>}
                  {this.state.deleteSuccess == false && <Alert Message={this.state.failureMsg} Type={3} closeBanner={true}></Alert>}
                  {this.state.blockAgainSuccess && <Alert Message={this.props.blockAgainResponse.successMsg} Type={2} closeBanner={true}></Alert>}
                  {this.state.powerCycle && this.props.addBlockCallMsgRes?.hasSuccessMsg && <Alert Message={"<span>In order to complete your service change </span>, you'll need to power cycle your device, or turn it off and on again. Once your phone turns back on, you'll be able to enjoy all the benefits of your service change."} Type={3} closeBanner={true}></Alert>}
                  {this.state.blockAgainSuccess == false && <Alert Message={this.props.blockAgainResponse.failureMsg} Type={3} closeBanner={true}></Alert>}
                  {this.state.editAllSuccess && <Alert Message={this.props.editAllBlockCallMsgRes.successMsg} Type={2} closeBanner={true}></Alert>}
                  {this.state.editAllSuccess == false && <Alert Message={this.props.editAllBlockCallMsgRes.failureMsg} Type={3} closeBanner={true}></Alert>}
                  {this.state.remainingBlockCount == 0 && <Alert Message={"You have used all of your blocks. To block another number delete one of the blocks below or add Family Base. which allows you to permanently block up to 20 contacts for a low monthly fee. You'll also be able to monitor and limit minute, text and data usage for up to 10 devices on your account."} Type={1} closeBanner={true}></Alert>}
                </div>
              </div>
                    <p >
                      Block calls and messages from up to {this.state.remainingBlockCount} numbers.
                    </p>
              <br />
              <div className={this.state.editNumber || this.state.editAllNumber || this.state.remainingBlockCount == 0 ? "radio-choose--disabled" : ""}>
                      <Body bold='true' size='large' >Enter a number</Body>
                      <Grid
                      >
                        <Row>
                          <Col colSizes={{ desktop: 6, mobile: 4,tablet:8 }} id="block_site_number">
                          <Input type="text"
                        onChange={(e) => this.handleOnChange(e, 'number')}
                        className={this.state.addnumberValid == false ? "txtError" : ""}
                        placeholder={common.getItemValue(pageItems,"textfield1Default")}
                        
                        name="block_site_number"
                        aria-labelledby="phoneAlert"
                        autoFocus
                        pattern="^\d{3}.\d{3}.\d{4}$"
                        touched={this.state.istouchedPrimary}
                        value={this.state.newNumber}
                        maxLength="12"
                        autoComplete="off" />
                          </Col>
                        </Row>
                      </Grid>
                      
                    {this.state.addnumberValid == false && <p id="phoneAlert" className="mb-18"> {common.getItemValue(pageItems,"textfield1Error")}</p>}
                    <br />
                  
                    <Button type="button" className="o-btn mb-0 btn-block" disabled={reactGlobals.isCsr || this.state.addnumberValid != true || this.state.remainingBlockCount===0} aria-labelledby="alertBlock" id="addSpamBtn" onClick={(e) => this.handleAddNumber(e)} data-track="CallsMessagesDesktopSaveButton" tabIndex="0" >Block</Button>
                    <br />

              </div>
              {blockedNumberList.length > 0 &&
              <div>
                    <Title bold size="large">{common.getItemValue(pageItems,"currNumbersHeader")}</Title>
                  <br />
              </div>

                }
              {blockedNumberList.length > 0 && <Fragment>
                {blockedNumberList}
              </Fragment>}

              <div className="row pt-25">
                <div className="col-lg-12 p-l-r-0 pb-10">
                  <div className="o-drawer-group o-accordion">
                    <TextLink href="javascript:void(0);" className={this.state.openToggleSM ? "anchor-link o-caret-down o-toggle o-expanded"
                      : "anchor-link o-caret-down o-toggle"} role="button"

                      id="Reportsuspectedspamtextmessages" aria-expanded={this.state.openToggleSM} aria-disabled="false" style={{ textDecoration: 'none' }} onClick={(e) => this.handleToggleSM(e, openToggleSM)} data-track="Reportsuspectedspamtextmessages" tabIndex="0" >
                      {common.getItemValue(pageItems,"spamLink")}</TextLink>

                    <div className={this.state.openToggleSM ? "accordion__body" : "accordion__body accordion__body--hidden"}
                      aria-hidden={this.state.openToggleSM ? false : true} >
                      <Body>{common.getItemValue(pageItems,"spamLinkMsg1")}</Body>
                      <Body>{common.getItemValue(pageItems,"spamLinkMsg2")}</Body>

                    </div>
                  </div>

                </div>
              </div>
              <div className="row">
                <div className="col-lg-12 p-l-r-0 pb-10">
                  <div className="o-drawer-group o-accordion">
                    <TextLink href="javascript:void(0);" className={this.state.openToggleBCE ? "anchor-link o-caret-down o-toggle o-expanded"
                      : "anchor-link o-caret-down o-toggle"} role="button"

                      id="blockedcontactexperience" aria-expanded={this.state.openToggleBCE} aria-disabled="false" style={{ textDecoration: 'none' }} onClick={(e) => this.handleToggle(e, openToggleBCE)} data-track="blockedcontactexperience" tabIndex="0">
                      {common.getItemValue(pageItems,"contactLink")}</TextLink>

                    <div className={this.state.openToggleBCE ? "accordion__body" : "accordion__body accordion__body--hidden"}
                      aria-hidden={this.state.openToggleBCE ? false : true} >
                      <Body size="large">{common.getItemValue(pageItems,"contactLinkMsg1")}</Body>
                      <Body size="large">{common.getItemValue(pageItems,"contactLinkMsg2")}</Body>
                    </div>
                  </div>
                </div>
              </div>
            </Body>
            {blocksAEMFFlag ?
            <div>
            <div ><Body> <TextLink style={{ textDecoration: 'none' }} onClick={(e) => {
              e.preventDefault();
              window.location.href = "https://www.verizonwireless.com/support/how-to-add-blocks-video/"
            }} className="anchor-link" data-track="VideoForBlockServices">Video: How to block services</TextLink></Body></div>
            <div style={{ padding: '5px' }}></div>
            <div ><Body><TextLink style={{ textDecoration: 'none' }} onClick={(e) => {
              e.preventDefault();
              window.location.href = "https://www.verizonwireless.com/support/block-unblock-services-faqs/"
            }} className="anchor-link" data-track="BlockFAQ">Block and unblock services FAQ</TextLink></Body></div>
            </div>
            :
            <div>
            <div><Body> <TextLink style={{ textDecoration: 'none' }} onClick={(e) => {
                e.preventDefault();
                let actionKey = pageContent && common.getActionKey(pageItems, `videoLink`);
                const actionKeyValue = pageContent && common.getActionByKey(pageActions, actionKey);
                const actionValue = actionKeyValue && actionKeyValue.actionValue;
                window.location.href = `${actionValue}`;
              }} data-track="VideoLink">{common.getItemValue(pageItems,'videoLink')}</TextLink></Body></div><br />
              <div ><Body> <TextLink style={{ textDecoration: 'none' }} onClick={(e) => {
                e.preventDefault();
                let actionKey = pageContent && common.getActionKey(pageItems, `faqsLink`);
                const actionKeyValue = pageContent && common.getActionByKey(pageActions, actionKey);
                const actionValue = actionKeyValue && actionKeyValue.actionValue;
                window.location.href = `${actionValue}`;
              }} data-track="FAQLink">{common.getItemValue(pageItems,'faqsLink')}</TextLink></Body></div><br />
               <br />
            </div>
            }
          </div>
        </div>
      </div >
    );
  }
}

const FAQsHeadSection = styled.div`
        margin-top: 0px;
        padding: 10px 0 12px;
        border-bottom: 2px solid #000;
        display: block;
        width: 100%;
        font-family: "NeueHaasGroteskDisplayBold", arial;
        font-size: 18px;
        color: #000000;
        clear: both;
        `;

const FAQsSection = styled.div`
        border-top: none;
        `;
const Unblock = styled.div`
        padding-top:10px;
        `;
const MobileNumber = styled.div`
        padding-right:450px;
        padding-left:30px;
        padding-bottom:10px;
        padding-top:10px;
`;

const mapStateToProps = (state) => {

  return {
    callsMessagesData: state.Detail.callsMsgs.callsMessages,
    blockedNumbers: state.Detail.callsMsgs.blockedNumbers,
    expiredNumbers: state.Detail.callsMsgs.expiredNumbers,
    getCMError: state.Detail.callsMsgs.getCMError,
    blockAgainResponse: state.Detail.callsMsgs.blockAgainResponse,
    addBlockCallMsgRes: state.Detail.callsMsgs.addBlockCallMsg,
    editBlockCallMsgRes: state.Detail.callsMsgs.editBlockCallMsg,
    deleteBlockCallMsgRes: state.Detail.callsMsgs.deleteBlockCallMsg,
    editAllBlockCallMsgRes: state.Detail.callsMsgs.editAllBlockCallMsg,
    deviceList: state.Detail.devices,
    isFetching: state.Detail.callsMsgs.isFetching,

  };
};

export default connect(
  mapStateToProps,
  { getCallsMessages, postaddBlockCallMsg, postDeleteBlockCallMsg }
)(BlockCallsMessages);
