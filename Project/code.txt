/**
 * @jest-environment jsdom
 */
import React from "react";
import { render, fireEvent, screen, act } from "@testing-library/react";
import { Provider } from "react-redux";
import configureStore from "redux-mock-store";
import thunk from "redux-thunk";
import BlockCallsMessages from "../BlockCallsMessages";

// Mocks
jest.mock("../../../../shared/utilities/commonExp", () => ({
  mobileNumberFormat: jest.fn((n) => `(${n})`),
}));

jest.mock("../actions/fetchCallsMessages", () => ({
  getCallsMessages: jest.fn(() => Promise.resolve()),
  postaddBlockCallMsg: jest.fn(() => Promise.resolve()),
  postDeleteBlockCallMsg: jest.fn(() => Promise.resolve())
}));

jest.mock("../../../../shared/utilities/util", () => ({
  getContentFromSection: jest.fn(() => ({
    sections: [
      {
        contents: [
          {
            items: {
              headerText: "Header",
              textfield1Default: "Enter number",
              textfield1Error: "Invalid number",
              currNumbersHeader: "Blocked Numbers",
              spamLink: "Report Spam",
              spamLinkMsg1: "Msg1",
              spamLinkMsg2: "Msg2",
              contactLink: "Contact Experience",
              contactLinkMsg1: "C1",
              contactLinkMsg2: "C2",
              videoLink: "Video Link",
              faqsLink: "FAQ Link"
            }
          }
        ],
        actions: [
          { actionKey: "videoLink", actionValue: "/video" },
          { actionKey: "faqsLink", actionValue: "/faq" }
        ]
      }
    ]
  })),

  getItemValue: jest.fn((items, key) => items[key]),
  getActionKey: jest.fn((items, key) => key),
  getActionByKey: jest.fn((actions, key) => actions.find(a => a.actionKey === key))
}));

global.reactGlobals = { isCsr: false };

const middlewares = [thunk];
const mockStore = configureStore(middlewares);

const initialState = {
  Detail: {
    callsMsgs: {
      callsMessages: {
        sections: [{}],
        remainingBlockCount: 5,
        blocksAEMFFlag: false,
      },
      blockedNumbers: [
        { phoneNumber: "1234567890", memo: "m1" }
      ],
      expiredNumbers: [],
      getCMError: {},
      blockAgainResponse: {},
      addBlockCallMsg: {},
      editBlockCallMsg: {},
      deleteBlockCallMsg: {},
      editAllBlockCallMsg: {},
      isFetching: false,
    },
    devices: []
  }
};

const setup = (customState = {}) => {
  const store = mockStore({ ...initialState, ...customState });
  return render(
    <Provider store={store}>
      <BlockCallsMessages
        selectedDevice={{ encryptedMtn: "XYZ" }}
        selectedAccordian=""
        selectAccordian={jest.fn()}
      />
    </Provider>
  );
};

describe("BlockCallsMessages Tests - FULL COVERAGE", () => {

  test("renders component and opens accordion", async () => {
    setup();

    const header = screen.getByText("Block calls & messages");
    fireEvent.click(header);

    expect(screen.getByText("Header")).toBeInTheDocument();
  });

  test("input validation - valid + invalid", async () => {
    setup();
    const header = screen.getByText("Block calls & messages");
    fireEvent.click(header);

    const input = screen.getByPlaceholderText("Enter number");

    fireEvent.change(input, { target: { value: "12" } });
    expect(screen.getByText("Invalid number")).toBeInTheDocument();

    fireEvent.change(input, { target: { value: "1234567890" } });

    const btn = screen.getByText("Block");
    expect(btn).not.toBeDisabled();
  });

  test("add block number success", async () => {
    const store = mockStore({
      ...initialState,
      Detail: {
        ...initialState.Detail,
        callsMsgs: {
          ...initialState.Detail.callsMsgs,
          addBlockCallMsg: {
            statusCode: "00",
            powerCycle: true,
            blockedPhoneNumbers: [{ phoneNumber: "9998887777" }],
            expiredBlockedPhoneNumbers: [],
            remainingBlockCount: 4,
            hasSuccessMsg: true,
            hasFailureMsg: false,
            successMsg: "Added",
          }
        }
      }
    });

    render(
      <Provider store={store}>
        <BlockCallsMessages selectedDevice={{ encryptedMtn: "XYZ" }} selectedAccordian="" selectAccordian={jest.fn()} />
      </Provider>
    );

    fireEvent.click(screen.getByText("Block calls & messages"));

    const input = screen.getByPlaceholderText("Enter number");
    fireEvent.change(input, { target: { value: "1234567890" } });

    fireEvent.click(screen.getByText("Block"));

    expect(await screen.findByText("Added")).toBeInTheDocument();
  });

  test("add block number failure", async () => {
    const store = mockStore({
      ...initialState,
      Detail: {
        ...initialState.Detail,
        callsMsgs: {
          ...initialState.Detail.callsMsgs,
          addBlockCallMsg: {
            statusCode: "01",
            hasFailureMsg: true,
            failureMsg: "Failed"
          }
        }
      }
    });

    render(
      <Provider store={store}>
        <BlockCallsMessages selectedDevice={{ encryptedMtn: "XYZ" }} selectedAccordian="" selectAccordian={jest.fn()} />
      </Provider>
    );

    fireEvent.click(screen.getByText("Block calls & messages"));
    expect(await screen.findByText("Failed")).toBeInTheDocument();
  });

  test("delete number success", async () => {
    const store = mockStore({
      ...initialState,
      Detail: {
        ...initialState.Detail,
        callsMsgs: {
          ...initialState.Detail.callsMsgs,
          deleteBlockCallMsg: {
            statusCode: "00",
            blockedPhoneNumbers: [],
            remainingBlockCount: 5,
            hasSuccessMsg: true,
            successMsg: "Deleted"
          }
        }
      }
    });

    render(
      <Provider store={store}>
        <BlockCallsMessages selectedDevice={{ encryptedMtn: "XYZ" }} selectedAccordian="CM" selectAccordian={jest.fn()} />
      </Provider>
    );

    fireEvent.click(screen.getByText("Unblock"));
    expect(await screen.findByText("Deleted")).toBeInTheDocument();
  });

  test("toggle spam drawer", () => {
    setup();
    fireEvent.click(screen.getByText("Block calls & messages"));
    fireEvent.click(screen.getByText("Report Spam"));
    expect(screen.getByText("Msg1")).toBeInTheDocument();
  });

  test("toggle contact drawer", () => {
    setup();
    fireEvent.click(screen.getByText("Block calls & messages"));
    fireEvent.click(screen.getByText("Contact Experience"));
    expect(screen.getByText("C1")).toBe