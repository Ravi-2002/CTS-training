import React, { Fragment, useState } from 'react';
import Page from '@lib/components/Page';
import { Title } from '@lib/components/Typography';
import styled from "styled-components";
import { Button } from '@vds/buttons';
import { useLocation, useHistory } from 'react-router-dom';
import callBackend from '../../../lib/services/callBackend';
import { POST } from '../../../lib/constants';
import landingData from '../../../../mock/scan/get/landing.json';
import { postHttpClientRequest } from '../httpClient';
import * as configvalues from '../../../lib/config/globalConfig.json';


const BodyWrapper = styled.div`
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  height: 50vh;
  margin: 8vh 20vw;
  @media (max-width: 768px){
   margin: 0;
  }
`;
const Content = styled.div`
  display: flex;
  flex-direction: column; 
  justify-content: center;
  align-items: center;
  gap: 20px;
`;
const BtnContainer = styled.div`
  margin-top: 15px;
  display: flex; 
  flex-direction: row; 
  align-items: flex-start; 
  gap: 50px;
    & button {
    width: 12.5rem;
      @media (max-width: 768px){
      width: 9.5rem;
      }
    }
`;

const Submission = () => {
  const history = useHistory();
  const location = useLocation();
  const imageUrl = location.state?.url;
  const [optOut, setoptOut] = useState("");


  const submitIdDocument = async () => { 
        const reqData = buildReqData();
        const baseUrl = reactGlobals.baseUrl +  reactGlobals.submitUrl;
        console.log(reactGlobals.manageTouchlessScanFFlag,'manageTouchlessScanFFlag');
        postHttpClientRequest(baseUrl, reqData, null);
        if(reactGlobals.manageTouchlessScanFFlag){
        history.push('/success');
        }
               
  };

  const buildReqData = () => {

    let modifiedDataUri = imageUrl?.split("base64,"); // remove sub string "data:image/png;base64," from image data
    const idImageFront = imageUrl ? modifiedDataUri?.[1] : "";

    if (!imageUrl) {
      setoptOut("Y");
    } else {
      setoptOut("N");
    }

    let reqData = {

      idImageFront: idImageFront,
      customerAction: "",
      customerOpted: "",
      transactionType: "",
      ignoreCache: false,
      locationCode: reactGlobals.locationCode,
      mtn: "",
      ssCluster: reactGlobals.ssCluster,
      transactionId: reactGlobals.transactionId

    }

    populateTransactionType(reqData);
    return reqData;
  }

  const populateTransactionType = (values) => {
    if (optOut && optOut === 'Y') {
      values.customerOpted = 'N';
      if (reactGlobals.destinationFlow === 'SCAN_ID') {
        values.transactionType = 'MVO_ID_ADT_AUTH_NOTHANKS';
      } else {
        values.transactionType = 'MVO_ID_SMART_LINK_NOTHANKS';
      }
    }
    else {
      values.customerOpted = 'Y';
      if (reactGlobals.destinationFlow === 'SCAN_ID') {
        values.transactionType = 'MVO_ID_ADT_AUTH_TOUCHLESS';
      } else {
        values.transactionType = 'MVO_ID_SMART_LINK_TOUCHLESS';
      }
    }

  }

  const routeToScanPage = () => {
    history.replace('/scan');
  }

  return (
    <Page nativeTitle="submission">
      <Fragment>
        <BodyWrapper>
          <Content>
              <img src={imageUrl} alt="Screenshot" />
            <Title mb="20" size="large" bold={true}>
              {landingData?.content?.submitPage?.reTaketitle}
            </Title>
          </Content>
          <BtnContainer>
            <Button use="secondary" onClick={routeToScanPage}>
              {landingData?.content?.submitPage?.retake}
            </Button>
            <Button onClick={submitIdDocument}>
              {landingData?.content?.submitPage?.submit}
            </Button>
          </BtnContainer>
        </BodyWrapper>
      </Fragment>
    </Page >
  );
};
export default Submission;
