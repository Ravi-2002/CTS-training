import React from 'react';
import { Provider } from 'react-redux';
import { render } from '@testing-library/react';
import configureStore from 'redux-mock-store';
import thunk from 'redux-thunk';
import BlockCallsMessages from '../BlockCallsMessages';

const mockStore = configureStore([thunk]);

describe('BlockCallsMessages - deleteNumber', () => {
  let store;

  beforeEach(() => {
    store = mockStore({
      Detail: {
        selectedDevice: {
          encryptedMtn: 'encrypted123'
        },
        callsMessages: {
          deleteBlockCallMsgRes: {}
        }
      }
    });

    // Mock reactGlobals locally
    global.reactGlobals = { isCsr: false };

    // DOM setup for scroll target
    const alertDiv = document.createElement('div');
    alertDiv.setAttribute('id', 'myalert');
    document.body.appendChild(alertDiv);
  });

  const renderWithRef = (props, store) => {
    const ref = React.createRef();

    render(
      <Provider store={store}>
        <BlockCallsMessages ref={ref} {...props} />
      </Provider>
    );

    return ref;
  };

  test('deleteNumber sets success state when statusCode is "00"', async () => {
    const props = {
      selectedDevice: { encryptedMtn: 'encrypted123' },
      postDeleteBlockCallMsg: jest.fn(() => Promise.resolve()),
      deleteBlockCallMsgRes: {
        statusCode: '00',
        blockedPhoneNumbers: ['9876543210'],
        expiredBlockedPhoneNumbers: [],
        remainingBlockCount: 3,
        successMsg: 'Deleted successfully',
        failureMsg: ''
      }
    };

    const ref = renderWithRef(props, store);

    const scrollSpy = jest.spyOn(window, 'scrollTo').mockImplementation(() => {});

    await ref.current.deleteNumber({ preventDefault: () => {} }, {
      phoneNumber: '9876543210',
      memo: 'spam'
    });

    expect(props.postDeleteBlockCallMsg).toHaveBeenCalledWith({
      mtn: 'encrypted123',
      blockNumber: '9876543210',
      oldPhoneNumber: '9876543210',
      expiredPhoneNumber: '',
      blockedNumbers: [],
      memo: 'spam',
      applyAll: false,
      onlyMemo: false
    });

    expect(ref.current.state.deleteSuccess).toBe(true);
    expect(ref.current.state.trackingId).toBe('CallsMessagesSuccessNotification');
    expect(ref.current.state.successMsg).toBe('Deleted successfully');

    scrollSpy.mockRestore();
  });

  test('deleteNumber sets failure state when statusCode is not "00"', async () => {
    const props = {
      selectedDevice: { encryptedMtn: 'encrypted123' },
      postDeleteBlockCallMsg: jest.fn(() => Promise.resolve()),
      deleteBlockCallMsgRes: {
        statusCode: '01',
        failureMsg: 'Something went wrong'
      }
    };

    const ref = renderWithRef(props, store);

    await ref.current.deleteNumber({ preventDefault: () => {} }, {
      phoneNumber: '1112223333',
      memo: 'testfail'
    });

    expect(props.postDeleteBlockCallMsg).toHaveBeenCalled();
    expect(ref.current.state.deleteSuccess).toBe(false);
    expect(ref.current.state.trackingId).toBe('CallsMessagesFailureNotification');
  });
});