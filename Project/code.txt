import React from 'react';
import ReactDOM from 'react-dom';
import { Provider } from 'react-redux';
import configureStore from 'redux-mock-store';
import thunk from 'redux-thunk';
import BlockCallsMessages from '../BlockCallsMessages';

const mockStore = configureStore([thunk]);

describe('BlockCallsMessages - deleteNumber method coverage', () => {
  let store;
  let container;

  beforeEach(() => {
    store = mockStore({
      Detail: {
        selectedDevice: {
          encryptedMtn: 'encrypted123'
        },
        callsMessages: {
          deleteBlockCallMsgRes: {}
        }
      }
    });

    // reactGlobals mock
    global.reactGlobals = { isCsr: false };

    // Add #myalert div for scrolling
    const alertDiv = document.createElement('div');
    alertDiv.setAttribute('id', 'myalert');
    document.body.appendChild(alertDiv);

    // Create container for rendering
    container = document.createElement('div');
    document.body.appendChild(container);
  });

  afterEach(() => {
    document.body.innerHTML = '';
  });

  test('should call deleteNumber and update state on success', async () => {
    const props = {
      selectedDevice: { encryptedMtn: 'encrypted123' },
      postDeleteBlockCallMsg: jest.fn(() => Promise.resolve()),
      deleteBlockCallMsgRes: {
        statusCode: '00',
        blockedPhoneNumbers: ['9876543210'],
        expiredBlockedPhoneNumbers: [],
        remainingBlockCount: 3,
        successMsg: 'Deleted successfully',
        failureMsg: ''
      }
    };

    let componentInstance = null;

    class Wrapper extends React.Component {
      render() {
        return (
          <Provider store={store}>
            <BlockCallsMessages
              ref={(ref) => {
                componentInstance = ref;
              }}
              {...props}
            />
          </Provider>
        );
      }
    }

    // Render manually via ReactDOM
    await ReactDOM.render(<Wrapper />, container);

    const scrollSpy = jest.spyOn(window, 'scrollTo').mockImplementation(() => {});

    await componentInstance.deleteNumber({ preventDefault: () => {} }, {
      phoneNumber: '9876543210',
      memo: 'spam'
    });

    expect(props.postDeleteBlockCallMsg).toHaveBeenCalledWith({
      mtn: 'encrypted123',
      blockNumber: '9876543210',
      oldPhoneNumber: '9876543210',
      expiredPhoneNumber: '',
      blockedNumbers: [],
      memo: 'spam',
      applyAll: false,
      onlyMemo: false
    });

    expect(componentInstance.state.deleteSuccess).toBe(true);
    expect(componentInstance.state.trackingId).toBe('CallsMessagesSuccessNotification');
    expect(componentInstance.state.successMsg).toBe('Deleted successfully');

    scrollSpy.mockRestore();
  });

  test('should call deleteNumber and set failure state on non-00 status', async () => {
    const props = {
      selectedDevice: { encryptedMtn: 'encrypted123' },
      postDeleteBlockCallMsg: jest.fn(() => Promise.resolve()),
      deleteBlockCallMsgRes: {
        statusCode: '01',
        failureMsg: 'Something went wrong'
      }
    };

    let componentInstance = null;

    class Wrapper extends React.Component {
      render() {
        return (
          <Provider store={store}>
            <BlockCallsMessages
              ref={(ref) => {
                componentInstance = ref;
              }}
              {...props}
            />
          </Provider>
        );
      }
    }

    await ReactDOM.render(<Wrapper />, container);

    await componentInstance.deleteNumber({ preventDefault: () => {} }, {
      phoneNumber: '1112223333',
      memo: 'testfail'
    });

    expect(props.postDeleteBlockCallMsg).toHaveBeenCalled();
    expect(componentInstance.state.deleteSuccess).toBe(false);
    expect(componentInstance.state.trackingId).toBe('CallsMessagesFailureNotification');
  });
});